<!-- CONTROLES -->
<div class="controls">
  <!-- Zoom -->
  <button class="icon-btn" (click)="zoomOut()" title="Zoom out (CTRL + -)">
    <i class="fas fa-search-minus"></i>
  </button>
  <button class="icon-btn" (click)="zoomIn()" title="Zoom in (CTRL + +)">
    <i class="fas fa-search-plus"></i>
  </button>
  <button class="icon-btn" (click)="resetView()" title="Reset (CTRL + 0)">
    <i class="fas fa-compress"></i>
  </button>
  <button class="icon-btn" (click)="fitToScreen()" title="Ajustar à tela">
    <i class="fas fa-expand"></i>
  </button>

  <!-- Estilo linha -->
  <button class="icon-btn" (click)="toggleSolidMode()" [class.active]="lineStyle==='solid'" title="Linha contínua">
    <i class="fas fa-minus"></i>
  </button>
  <button class="icon-btn" (click)="toggleDashedMode()" [class.active]="lineStyle==='dashed'" title="Linha tracejada">
    <i class="fas fa-ellipsis-h"></i>
  </button>

  <!-- Remoções -->
  <button class="icon-btn" (click)="toggleDeleteMode()" [class.active]="deleteMode" title="Apagar ligação">
    <i class="fas fa-cut"></i>
  </button>
  <button class="icon-btn" (click)="toggleServiceDeleteMode()" [class.active]="serviceDeleteMode" title="Apagar serviço">
    <i class="fas fa-trash"></i>
  </button>
</div>

<!-- CANVAS raiz -->
<div
  #canvasRef
  class="canvas"
  cdkDropList
  id="canvas-drop"
  [cdkDropListConnectedTo]="['palette-drop']"
  (cdkDropListDropped)="onDrop($event)"
  (wheel)="onWheel($event)"
  (pointerdown)="onPointerDown($event)"
  (pointermove)="onPointerMove($event)"
  (pointerup)="onPointerUp($event)"
  [class.service-delete-mode]="serviceDeleteMode"
>
  <!-- grade / fundo -->
  <div class="grid"></div>

  <!-- viewport que recebe pan/zoom -->
  <div #viewportRef class="viewport" [style.transform]="transform" [style.transform-origin]="transformOrigin">

    <!-- linhas -->
    <svg class="connections">
      <g *ngFor="let conn of portConnections; let i = index" (click)="onPortLineClick(i)">
        <path class="hit-area"
              [attr.d]="'M ' + getPortXY(conn.source).x + ' ' + getPortXY(conn.source).y + ' L ' + getPortXY(conn.target).x + ' ' + getPortXY(conn.target).y">
        </path>
        <path class="visible-line"
              [ngClass]="conn.style"
              [attr.d]="'M ' + getPortXY(conn.source).x + ' ' + getPortXY(conn.source).y + ' L ' + getPortXY(conn.target).x + ' ' + getPortXY(conn.target).y">
        </path>
      </g>
    </svg>

    <!-- VPCs (atrás dos nós) -->
    <div
      class="vpc"
      *ngFor="let v of vpcs; let vi = index"
      [style.left.px]="v.x - 0"
      [style.top.px]="v.y - 0"
      [style.width.px]="v.w"
      [style.height.px]="v.h"
    >
      <div class="vpc-titlebar" (mousedown)="startVpcDrag(vi, $event)">
        <i class="fas fa-network-wired"></i>
        <span class="label">{{ v.label }}</span>
      </div>

      <!-- resize handles -->
      <div class="vpc-handle n"  (mousedown)="startVpcResize(vi, 'n', $event)"></div>
      <div class="vpc-handle s"  (mousedown)="startVpcResize(vi, 's', $event)"></div>
      <div class="vpc-handle e"  (mousedown)="startVpcResize(vi, 'e', $event)"></div>
      <div class="vpc-handle w"  (mousedown)="startVpcResize(vi, 'w', $event)"></div>
      <div class="vpc-handle ne" (mousedown)="startVpcResize(vi, 'ne', $event)"></div>
      <div class="vpc-handle nw" (mousedown)="startVpcResize(vi, 'nw', $event)"></div>
      <div class="vpc-handle se" (mousedown)="startVpcResize(vi, 'se', $event)"></div>
      <div class="vpc-handle sw" (mousedown)="startVpcResize(vi, 'sw', $event)"></div>
    </div>

    <!-- Serviços (nós) -->
    <div
      class="node"
      *ngFor="let s of droppedServices; let i = index"
      [class.in-vpc]="$any(s).parentId"
      [style.left.px]="s.x - NODE_W/2"
      [style.top.px]="s.y - NODE_H/2"
      [style.width.px]="NODE_W"
      [style.height.px]="NODE_H"
      (mousedown)="startNodeDrag(i, $event)"
      (click)="onServiceClick(i, $event)"
    >
      <img [src]="s.icon" class="node-icon" />
      <div class="node-label">{{ s.label }}</div>

      <!-- portas -->
      <button class="port top"    type="button" (click)="onPortClick(i, 'top', $event)"></button>
      <button class="port right"  type="button" (click)="onPortClick(i, 'right', $event)"></button>
      <button class="port bottom" type="button" (click)="onPortClick(i, 'bottom', $event)"></button>
      <button class="port left"   type="button" (click)="onPortClick(i, 'left', $event)"></button>
    </div>
  </div>
</div>
