<div class="canvas-container">
  <div class="controls">
    <button
      class="icon-btn"
      (click)="toggleDashedMode()
      "
      [class.active]="drawMode && lineStyle === 'dashed'"
      title="Desenhar tracejado"
    >
      <i class="fa-solid fa-ellipsis icon-fa"></i>
    </button>

    <button
      class="icon-btn"
      (click)="toggleSolidMode()"
      [class.active]="drawMode && lineStyle === 'solid'"
      title="Desenhar sólido"
    >
      <i class="fa-solid fa-minus icon-fa"></i>
    </button>

    <button
      class="icon-btn"
      (click)="toggleDeleteMode()"
      [class.active]="deleteMode"
      title="Apagar linhas"
    >
      <i class="fa-solid fa-scissors icon-fa"></i>
    </button>

    <button
      class="icon-btn"
      (click)="toggleServiceDeleteMode()"
      [class.active]="serviceDeleteMode"
      title="Apagar serviço"
    >
      <i class="fa-solid fa-trash icon-fa"></i>
    </button>
  </div>

  <div
    #canvasRef
    class="canvas"
    [class.service-delete-mode]="serviceDeleteMode"
    [class.show-ports]="!!portDraft.from"
    cdkDropList
    id="canvas-drop"
    [cdkDropListConnectedTo]="['palette-drop']"
    (cdkDropListDropped)="onDrop($event)"
    (click)="onCanvasClick($event)"
    (mousemove)="onCanvasMouseMove($event)"
    (mouseleave)="onCanvasMouseLeave()"
  >
    <svg class="connections">
      <!-- linhas antigas (click-to-click) -->
      <ng-container *ngFor="let conn of connections; let i = index">
        <line
          class="hit-area"
          (click)="onLineClick(i)"
          [attr.x1]="conn.x1"
          [attr.y1]="conn.y1"
          [attr.x2]="conn.x2"
          [attr.y2]="conn.y2"
        ></line>
        <line
          class="visible-line"
          [ngClass]="conn.style"
          [attr.x1]="conn.x1"
          [attr.y1]="conn.y1"
          [attr.x2]="conn.x2"
          [attr.y2]="conn.y2"
        ></line>
      </ng-container>

      <!-- novas conexões entre portas -->
      <ng-container *ngFor="let p of portConnections; let j = index">
        <line
          class="hit-area"
          (click)="onPortLineClick(j)"
          [attr.x1]="getPortXY(p.source).x"
          [attr.y1]="getPortXY(p.source).y"
          [attr.x2]="getPortXY(p.target).x"
          [attr.y2]="getPortXY(p.target).y"
        ></line>
        <line
          class="visible-line"
          [ngClass]="p.style"
          [attr.x1]="getPortXY(p.source).x"
          [attr.y1]="getPortXY(p.source).y"
          [attr.x2]="getPortXY(p.target).x"
          [attr.y2]="getPortXY(p.target).y"
        ></line>
      </ng-container>

      <!-- preview enquanto conecta portas -->
      <line
        *ngIf="portDraft.from && portDraft.toXY"
        class="visible-line dashed"
        [attr.x1]="getPortXY(portDraft.from!).x"
        [attr.y1]="getPortXY(portDraft.from!).y"
        [attr.x2]="portDraft.toXY!.x"
        [attr.y2]="portDraft.toXY!.y"
      ></line>
    </svg>

    
    <!-- Renderização de nós e contêineres -->
    <ng-container *ngFor="let svc of droppedServices; let i = index">
      <!-- VPC como janela/contêiner -->
      <div *ngIf="(svc.type ?? normalizeType(svc.label)) === 'vpc'"
           class="vpc-container"
           [ngStyle]="{ left: svc.x + 'px', top: svc.y + 'px', width: (svc.w || 520) + 'px', height: (svc.h || 360) + 'px' }"
           >
        <div class="vpc-header" (mousedown)="startNodeDrag(i, $event)">
          <img src="icons/vpc.png" alt="VPC" class="vpc-icon" />
          <span class="vpc-title">{{ svc.label }}</span>
        </div>
        <div class="vpc-body"><!-- serviços aparecem por cima; este é só o fundo --></div>
        <div class="vpc-resize" (mousedown)="startVpcResize(i, $event)"></div>
      </div>

      <!-- Demais serviços (quadradinhos) -->
      <div *ngIf="(svc.type ?? normalizeType(svc.label)) !== 'vpc'"
           class="node" [class.dragging]="draggingIndex===i"
           #nodeElem
           [ngStyle]="{ left: svc.x + 'px', top: svc.y + 'px' }"
           (click)="onServiceClick(i, $event)"
            (mousedown)="startNodeDrag(i, $event)">
        <img [src]="svc.icon" class="node-icon" />
        <div class="node-label">{{ svc.label }}</div>

        <!-- quatro portas clicáveis -->
        <button class="port top"
                (mousedown)="onPortDown(i,'top',$event)"
                (mouseup)="onPortUp(i,'top',$event)"></button>
        <button class="port right"
                (mousedown)="onPortDown(i,'right',$event)"
                (mouseup)="onPortUp(i,'right',$event)"></button>
        <button class="port bottom"
                (mousedown)="onPortDown(i,'bottom',$event)"
                (mouseup)="onPortUp(i,'bottom',$event)"></button>
        <button class="port left"
                (mousedown)="onPortDown(i,'left',$event)"
                (mouseup)="onPortUp(i,'left',$event)"></button>
      </div>
    </ng-container>
  </div>
</div>