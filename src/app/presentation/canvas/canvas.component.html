<!-- CONTROLES -->
<div class="controls">
  <!-- Zoom -->
  <button class="icon-btn" (click)="zoomOut()" title="Zoom out (CTRL + -)">
    <i class="fas fa-search-minus"></i>
  </button>
  <button class="icon-btn" (click)="zoomIn()" title="Zoom in (CTRL + +)">
    <i class="fas fa-search-plus"></i>
  </button>
  <button class="icon-btn" (click)="resetView()" title="Reset (CTRL + 0)">
    <i class="fas fa-compress"></i>
  </button>
  <button class="icon-btn" (click)="fitToScreen()" title="Ajustar à tela">
    <i class="fas fa-expand"></i>
  </button>

  <!-- Estilo de linha -->
  <button class="icon-btn" (click)="toggleDashedMode()" [class.active]="lineStyle === 'dashed'" title="Linha tracejada">
    <i class="fas fa-ellipsis-h"></i>
  </button>
  <button class="icon-btn" (click)="toggleSolidMode()" [class.active]="lineStyle === 'solid'" title="Linha sólida">
    <i class="fas fa-minus"></i>
  </button>

  <!-- Modos de exclusão -->
  <button class="icon-btn" (click)="toggleDeleteMode()" [class.active]="deleteMode" title="Excluir ligação">
    <i class="fas fa-eraser"></i>
  </button>
  <button class="icon-btn" (click)="toggleServiceDeleteMode()" [class.active]="serviceDeleteMode" title="Excluir serviço">
    <i class="fas fa-trash"></i>
  </button>

<!-- CANVAS -->
<div
  #canvasRef
  class="canvas"
  [class.linking]="!!linkingFrom"
  cdkDropList
  id="canvas-drop"
  [cdkDropListConnectedTo]="['palette-drop']"
  (cdkDropListDropped)="onDrop($event)"
  (wheel)="onWheel($event)"
  (pointerdown)="onPointerDown($event)"
  (pointermove)="onPointerMove($event)"
  (pointerup)="onPointerUp($event)"
>
  <div #viewportRef class="viewport" [style.transform]="transform" [style.transformOrigin]="transformOrigin">
    <svg class="connections">
      <!-- ligações reais (cada uma respeita o seu estilo salvo) -->
      <ng-container *ngFor="let pc of portConnections; let j = index">
        <line
          class="hit-area" (click)="onPortLineClick(j)"
          [attr.x1]="getPortXY(pc.source).x" [attr.y1]="getPortXY(pc.source).y"
          [attr.x2]="getPortXY(pc.target).x" [attr.y2]="getPortXY(pc.target).y"
        ></line>
        <line
          class="visible-line" [ngClass]="pc.style"
          [attr.x1]="getPortXY(pc.source).x" [attr.y1]="getPortXY(pc.source).y"
          [attr.x2]="getPortXY(pc.target).x" [attr.y2]="getPortXY(pc.target).y"
        ></line>
      </ng-container>

      <!-- preview do link (usa o estilo selecionado no menu) -->
      <line
        *ngIf="linkingFrom"
        class="visible-line preview"
        [ngClass]="lineStyle"
        [attr.x1]="getPortXY(linkingFrom!).x"
        [attr.y1]="getPortXY(linkingFrom!).y"
        [attr.x2]="mouseWorldX"
        [attr.y2]="mouseWorldY"
      ></line>
    </svg>

    <!-- NODES -->
    <div
      class="node"
      *ngFor="let s of droppedServices; let i = index"
      [style.left.px]="s.x"
      [style.top.px]="s.y"
      (mousedown)="startNodeDrag(i, $event)"
      (click)="onServiceClick(i, $event)"
    >
      <img [src]="s.icon" class="node-icon" />
      <div class="node-label">{{ s.label }}</div>

      <!-- portas -->
      <button class="port top"    type="button" (click)="onPortClick(i, 'top', $event)"></button>
      <button class="port right"  type="button" (click)="onPortClick(i, 'right', $event)"></button>
      <button class="port bottom" type="button" (click)="onPortClick(i, 'bottom', $event)"></button>
      <button class="port left"   type="button" (click)="onPortClick(i, 'left', $event)"></button>
    </div>
  </div>
</div>
