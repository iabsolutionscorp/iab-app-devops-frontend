<div
  #canvas
  class="canvas"
  cdkDropList
  cdkDropListId="canvas-drop"
  [cdkDropListConnectedTo]="connectedDropLists"
  (cdkDropListDropped)="onDrop($event)"
  (mousemove)="onCanvasMouseMove($event)"
  (mouseleave)="onCanvasMouseLeave()"
  (click)="onCanvasClick($event)"
  (document:pointermove)="onDocPointerMove($event)"
  (document:pointerup)="onDocPointerUp()"
>
  <!-- CAMADA DAS LINHAS -->
  <svg class="connections">
    <!-- linhas “livres” (se você usa) -->
    <ng-container *ngFor="let conn of connections; let i = index">
      <line class="hit-area"
            (click)="onLineClick(i)"
            [attr.x1]="conn.x1" [attr.y1]="conn.y1"
            [attr.x2]="conn.x2" [attr.y2]="conn.y2"></line>
      <line class="visible-line" [ngClass]="conn.style"
            [attr.x1]="conn.x1" [attr.y1]="conn.y1"
            [attr.x2]="conn.x2" [attr.y2]="conn.y2"></line>
    </ng-container>

    <!-- conexões porta-a-porta -->
    <ng-container *ngFor="let p of portConnections; let j = index">
      <line class="hit-area"
            (click)="onPortLineClick(j)"
            [attr.x1]="getPortXY(p.source).x" [attr.y1]="getPortXY(p.source).y"
            [attr.x2]="getPortXY(p.target).x" [attr.y2]="getPortXY(p.target).y"></line>
      <line class="visible-line" [ngClass]="p.style"
            [attr.x1]="getPortXY(p.source).x" [attr.y1]="getPortXY(p.source).y"
            [attr.x2]="getPortXY(p.target).x" [attr.y2]="getPortXY(p.target).y"></line>
    </ng-container>

    <!-- preview enquanto conecta -->
    <line *ngIf="portDraft.from && portDraft.toXY"
          class="visible-line dashed"
          [attr.x1]="getPortXY(portDraft.from!).x"
          [attr.y1]="getPortXY(portDraft.from!).y"
          [attr.x2]="portDraft.toXY!.x"
          [attr.y2]="portDraft.toXY!.y"></line>
  </svg>

  <!-- NÓS (quadradinhos) -->
  <div
    *ngFor="let node of nodes; let i = index"
    #nodeRef
    class="node"
    [style.left.px]="node.x"
    [style.top.px]="node.y"
    [style.width.px]="node.width"
    [style.height.px]="node.height"
    (pointerdown)="startDragNode(i, $event)"
  >
    <img *ngIf="node.icon" [src]="node.icon" class="node-icon" alt="" />
    <div class="node-label">{{ node.label }}</div>

    <!-- quatro portas -->
    <button class="port top"
            (mousedown)="onPortDown(i,'top',$event)"
            (mouseup)="onPortUp(i,'top',$event)"></button>
    <button class="port right"
            (mousedown)="onPortDown(i,'right',$event)"
            (mouseup)="onPortUp(i,'right',$event)"></button>
    <button class="port bottom"
            (mousedown)="onPortDown(i,'bottom',$event)"
            (mouseup)="onPortUp(i,'bottom',$event)"></button>
    <button class="port left"
            (mousedown)="onPortDown(i,'left',$event)"
            (mouseup)="onPortUp(i,'left',$event)"></button>
  </div>
</div>
